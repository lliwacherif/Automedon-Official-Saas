import{r as g,Y as I,a as T,U as l}from"./index-C1y38dmy.js";function x(){const i=g([]),n=g(!1),s=g(null),d=I(),v=T(()=>{const a={Renault:[],Dacia:[],Skoda:[],Hyundai:[],Seat:[],MG:[],Mahindra:[],Kia:[],Honda:[],Peugeot:[],Cherry:[],Geely:[]};return i.value.forEach(e=>{a[e.brand]&&a[e.brand].push(e)}),a}),c=a=>({id:a.id,brand:a.brand,model:a.model,plate_number:a.license_plate,status:a.status,image_url:a.image_url,mileage:a.mileage,auto_manage_status:a.auto_manage_status,created_at:a.created_at});async function m(){n.value=!0,s.value=null;const a=d.currentTenant?.id;if(!a){i.value=[],n.value=!1;return}try{const{data:e,error:r}=await l.from("cars").select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").eq("tenant_id",a).order("brand",{ascending:!0}).order("model",{ascending:!0});if(r)throw r;const t=new Date().toISOString(),{data:o,error:u}=await l.from("reservations").select("car_id, start_date, end_date").eq("tenant_id",a).in("status",["confirmed","active"]).gt("start_date",t).order("start_date",{ascending:!0});if(u)throw u;const b=(e||[]).map(E=>{const f=c(E),_=(o||[]).find(q=>q.car_id===f.id);return _&&(f.next_reservation={start_date:_.start_date,end_date:_.end_date}),f});i.value=b}catch(e){s.value=e.message,console.error("Error fetching cars:",e)}finally{n.value=!1}}async function p(a){n.value=!0,s.value=null;const e=d.currentTenant?.id;try{let r=l.from("cars").select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").eq("id",a);e&&(r=r.eq("tenant_id",e));const{data:t,error:o}=await r.single();if(o)throw o;return c(t)}catch(r){return s.value=r.message,console.error("Error fetching car:",r),null}finally{n.value=!1}}async function h(a){n.value=!0,s.value=null;const e=d.currentTenant?.id;if(!e)throw s.value="Context Tenant not found. Refresh the page.",n.value=!1,new Error("Context Tenant not found");try{const{data:r,error:t}=await l.from("cars").insert([{tenant_id:e,brand:a.brand,model:a.model,license_plate:a.plate_number,status:a.status,image_url:a.image_url||null}]).select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").single();if(t)throw t;return await m(),c(r)}catch(r){throw s.value=r.message,console.error("Error creating car:",r),r}finally{n.value=!1}}async function w(a,e){n.value=!0,s.value=null,d.currentTenant?.id||console.warn("Updating car without tenant context.");try{const t={};e.brand!==void 0&&(t.brand=e.brand),e.model!==void 0&&(t.model=e.model),e.plate_number!==void 0&&(t.license_plate=e.plate_number),e.status!==void 0&&(t.status=e.status),e.image_url!==void 0&&(t.image_url=e.image_url||null);const{data:o,error:u}=await l.from("cars").update(t).eq("id",a).select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at");if(u)throw u;return await m(),o?.[0]?c(o[0]):null}catch(t){throw s.value=t.message,console.error("Error updating car:",t),t}finally{n.value=!1}}async function y(a){n.value=!0,s.value=null;try{const{error:e}=await l.from("cars").delete().eq("id",a);if(e)throw e;await m()}catch(e){throw s.value=e.message,console.error("Error deleting car:",e),e}finally{n.value=!1}}return{cars:i,carsByBrand:v,loading:n,error:s,fetchCars:m,fetchCarById:p,createCar:h,updateCar:w,deleteCar:y}}export{x as u};
