import{r as w,Y as C,a as k,U as l,L as B}from"./index-BUxJS3To.js";function G(){const _=w([]),r=w(!1),i=w(null),m=C(),E=k(()=>{const t={Renault:[],Dacia:[],Skoda:[],Hyundai:[],Seat:[],MG:[],Mahindra:[],Kia:[],Honda:[],Peugeot:[],Cherry:[],Geely:[],Volkswagen:[],Suzuki:[]};return _.value.forEach(e=>{t[e.brand]&&t[e.brand].push(e)}),t}),f=t=>{let e=t.image_url;if(e&&e.includes("/storage/v1/object/public/car-images/"))try{const n=e.split("/storage/v1/object/public/car-images/")[1];if(n){const{data:a}=l.storage.from("car-images").getPublicUrl(n);e=a.publicUrl}}catch(n){console.warn("Error rewriting image URL:",n)}return{id:t.id,brand:t.brand,model:t.model,plate_number:t.license_plate,status:t.status,image_url:e,mileage:t.mileage,auto_manage_status:t.auto_manage_status,created_at:t.created_at}};async function g(){r.value=!0,i.value=null;const t=m.currentTenant?.id;if(!t){_.value=[],r.value=!1;return}try{const{data:e,error:n}=await l.from("cars").select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").eq("tenant_id",t).order("brand",{ascending:!0}).order("model",{ascending:!0});if(n)throw n;const a=new Date().toISOString(),u=B(new Date,"yyyy-MM-dd"),{data:c,error:h}=await l.from("reservations").select("car_id, start_date, end_date, client_name, contract_number, status").eq("tenant_id",t).in("status",["confirmed","active","completed"]).order("end_date",{ascending:!1});if(h)throw h;const{data:U,error:b}=await l.from("maintenance_records").select("car_id").eq("tenant_id",t).eq("maintenance_date",u);if(b)throw b;const R=new Set((U||[]).map(v=>v.car_id)),x=(e||[]).map(v=>{const s=f(v),d=(c||[]).find(o=>o.car_id===s.id&&o.start_date<=a&&o.end_date>=a),M=R.has(s.id);if(d)s.status="loue",s.active_reservation={start_date:d.start_date,end_date:d.end_date,client_name:d.client_name,contract_number:d.contract_number,status:d.status};else{const o=(c||[]).find(y=>y.car_id===s.id&&y.end_date<a);o&&(s.last_reservation={start_date:o.start_date,end_date:o.end_date,client_name:o.client_name,contract_number:o.contract_number,status:o.status}),M?s.status="maintenance":(s.status==="loue"||s.status==="maintenance")&&(s.status="disponible")}const p=(c||[]).find(o=>o.car_id===s.id&&o.start_date>a);return p&&(s.next_reservation={start_date:p.start_date,end_date:p.end_date}),s});_.value=x}catch(e){i.value=e.message,console.error("Error fetching cars:",e)}finally{r.value=!1}}async function q(t){r.value=!0,i.value=null;const e=m.currentTenant?.id;try{let n=l.from("cars").select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").eq("id",t);e&&(n=n.eq("tenant_id",e));const{data:a,error:u}=await n.single();if(u)throw u;return f(a)}catch(n){return i.value=n.message,console.error("Error fetching car:",n),null}finally{r.value=!1}}async function I(t){r.value=!0,i.value=null;const e=m.currentTenant?.id;if(!e)throw i.value="Context Tenant not found. Refresh the page.",r.value=!1,new Error("Context Tenant not found");try{const{data:n,error:a}=await l.from("cars").insert([{tenant_id:e,brand:t.brand,model:t.model,license_plate:t.plate_number,status:t.status,image_url:t.image_url||null}]).select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").single();if(a)throw a;return await g(),f(n)}catch(n){throw i.value=n.message,console.error("Error creating car:",n),n}finally{r.value=!1}}async function S(t,e){r.value=!0,i.value=null,m.currentTenant?.id||console.warn("Updating car without tenant context.");try{const a={};e.brand!==void 0&&(a.brand=e.brand),e.model!==void 0&&(a.model=e.model),e.plate_number!==void 0&&(a.license_plate=e.plate_number),e.status!==void 0&&(a.status=e.status),e.image_url!==void 0&&(a.image_url=e.image_url||null);const{data:u,error:c}=await l.from("cars").update(a).eq("id",t).select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at");if(c)throw c;return await g(),u?.[0]?f(u[0]):null}catch(a){throw i.value=a.message,console.error("Error updating car:",a),a}finally{r.value=!1}}async function T(t){r.value=!0,i.value=null;try{const{error:e}=await l.from("cars").delete().eq("id",t);if(e)throw e;await g()}catch(e){throw i.value=e.message,console.error("Error deleting car:",e),e}finally{r.value=!1}}return{cars:_,carsByBrand:E,loading:r,error:i,fetchCars:g,fetchCarById:q,createCar:I,updateCar:S,deleteCar:T}}export{G as u};
