import{r as w,Y as R,a as C,U as l,L as k}from"./index-_ynkWjCr.js";function j(){const m=w([]),n=w(!1),s=w(null),_=R(),b=C(()=>{const t={Renault:[],Dacia:[],Skoda:[],Hyundai:[],Seat:[],MG:[],Mahindra:[],Kia:[],Honda:[],Peugeot:[],Cherry:[],Geely:[],Volkswagen:[],Suzuki:[]};return m.value.forEach(e=>{t[e.brand]&&t[e.brand].push(e)}),t}),f=t=>{let e=t.image_url;if(e&&e.includes("/storage/v1/object/public/car-images/"))try{const r=e.split("/storage/v1/object/public/car-images/")[1];if(r){const{data:a}=l.storage.from("car-images").getPublicUrl(r);e=a.publicUrl}}catch(r){console.warn("Error rewriting image URL:",r)}return{id:t.id,brand:t.brand,model:t.model,plate_number:t.license_plate,status:t.status,image_url:e,mileage:t.mileage,auto_manage_status:t.auto_manage_status,created_at:t.created_at}};async function g(){n.value=!0,s.value=null;const t=_.currentTenant?.id;if(!t){m.value=[],n.value=!1;return}try{const{data:e,error:r}=await l.from("cars").select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").eq("tenant_id",t).order("brand",{ascending:!0}).order("model",{ascending:!0});if(r)throw r;const a=new Date().toISOString(),u=k(new Date,"yyyy-MM-dd"),{data:d,error:h}=await l.from("reservations").select("car_id, start_date, end_date, client_name, contract_number, status, total_price, advance_payment").eq("tenant_id",t).in("status",["confirmed","active"]).gte("end_date",a).order("start_date",{ascending:!0});if(h)throw h;const{data:T,error:y}=await l.from("maintenance_records").select("car_id").eq("tenant_id",t).eq("maintenance_date",u);if(y)throw y;const U=new Set((T||[]).map(p=>p.car_id)),x=(e||[]).map(p=>{const o=f(p),i=(d||[]).find(c=>c.car_id===o.id&&c.start_date<=a&&c.end_date>=a),M=U.has(o.id);i?(o.status="loue",o.active_reservation={start_date:i.start_date,end_date:i.end_date,client_name:i.client_name,contract_number:i.contract_number,status:i.status,total_price:i.total_price||0,advance_payment:i.advance_payment||0}):M?o.status="maintenance":(o.status==="loue"||o.status==="maintenance")&&(o.status="disponible");const v=(d||[]).find(c=>c.car_id===o.id&&c.start_date>a);return v&&(o.next_reservation={start_date:v.start_date,end_date:v.end_date}),o});m.value=x}catch(e){s.value=e.message,console.error("Error fetching cars:",e)}finally{n.value=!1}}async function E(t){n.value=!0,s.value=null;const e=_.currentTenant?.id;try{let r=l.from("cars").select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").eq("id",t);e&&(r=r.eq("tenant_id",e));const{data:a,error:u}=await r.single();if(u)throw u;return f(a)}catch(r){return s.value=r.message,console.error("Error fetching car:",r),null}finally{n.value=!1}}async function q(t){n.value=!0,s.value=null;const e=_.currentTenant?.id;if(!e)throw s.value="Context Tenant not found. Refresh the page.",n.value=!1,new Error("Context Tenant not found");try{const{data:r,error:a}=await l.from("cars").insert([{tenant_id:e,brand:t.brand,model:t.model,license_plate:t.plate_number,status:t.status,image_url:t.image_url||null}]).select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at").single();if(a)throw a;return await g(),f(r)}catch(r){throw s.value=r.message,console.error("Error creating car:",r),r}finally{n.value=!1}}async function I(t,e){n.value=!0,s.value=null,_.currentTenant?.id||console.warn("Updating car without tenant context.");try{const a={};e.brand!==void 0&&(a.brand=e.brand),e.model!==void 0&&(a.model=e.model),e.plate_number!==void 0&&(a.license_plate=e.plate_number),e.status!==void 0&&(a.status=e.status),e.image_url!==void 0&&(a.image_url=e.image_url||null);const{data:u,error:d}=await l.from("cars").update(a).eq("id",t).select("id, brand, model, license_plate, status, image_url, mileage, auto_manage_status, created_at");if(d)throw d;return await g(),u?.[0]?f(u[0]):null}catch(a){throw s.value=a.message,console.error("Error updating car:",a),a}finally{n.value=!1}}async function S(t){n.value=!0,s.value=null;try{const{error:e}=await l.from("cars").delete().eq("id",t);if(e)throw e;await g()}catch(e){throw s.value=e.message,console.error("Error deleting car:",e),e}finally{n.value=!1}}return{cars:m,carsByBrand:b,loading:n,error:s,fetchCars:g,fetchCarById:E,createCar:q,updateCar:I,deleteCar:S}}export{j as u};
